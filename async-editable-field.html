<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">
<link rel="import" href="../promise-polyfill/promise-polyfill-lite.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<dom-module id="async-editable-field">
  <template>
    <style>
      .error {
        border: solid 1px red;
      }
    </style>

    <iron-ajax id="ajaxRequest" url$="{{url}}" method="post" content-type="application/json" body$="{{requestBody}}" handle-as="json"
      on-response="_handleResponse" on-error="_handleErrorResponse"></iron-ajax>
    <span id="displayValue" hidden$="{{editing}}" on-tap="_editValue">{{value}}</span>
    <input id="textInput" class$="{{_getInputClasses(error)}}" hidden$="{{!editing}}" value="{{value}}" on-keydown="_handleKeyDown"
      on-blur="_handleBlur" />
    <span id="loading" hidden$="{{!loading}}">
      <paper-spinner active></paper-spinner>
    </span>
    <button id="saveButton" hidden$="{{_shouldHideButtons(editing, loading, showButtons)}}" on-tap="save">{{saveText}}</button>
    <button id="cancelButton" hidden$="{{_shouldHideButtons(editing, loading, showButtons)}}" on-tap="_cancelEdit">{{cancelText}}</button>
  </template>

  <script>
    /**
     * `async-editable-field`
     * This is an editable field component which can validate input and POST asynchronously
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
     Polymer({
      /* this is the element's prototype */
      is: 'async-editable-field',

      properties: {
        value: {
          type: String,
          value: ''
        },
        name: {
          type: String,
          value: 'value'
        },
        saveText: {
          type: String,
          value: 'Ok'
        },
        cancelText: {
          type: String,
          value: 'Cancel'
        },
        url: {
          type: String,
          value: null
        },
        showButtons: {
          type: Object,
          value: true
        },

        requestBody: {
          type: String,
          value: "{}",
          readOnly: true
        },
        editing: {
          type: Boolean,
          value: false,
          readOnly: true
        },
        loading: {
          type: Boolean,
          value: false,
          readOnly: true
        },
        error: {
          type: Boolean,
          value: false,
          readOnly: true
        },
        validationFunction: {
          type: Function,
          value: null,
          readOnly: true
        },
        successResponseFunction: {
          type: Function,
          value: null,
          readOnly: true          
        },
        errorResponseFunction: {
          type: Function,
          value: null,
          readOnly: true          
        }
      },

      validate: function() {     
        if (!this.validationFunction)
          return true;

        if (this.validationFunction(this.$.textInput.value)) {
          this._setError(false);
          return true;
        } else {
          this._setError(true);
          return false;
        }
      },

      save: function() {
        if (!this.validate())
            return;

        if (this.$.textInput.value == this.value || !this.url) {
          this._saveEdit();
          return;
        }

        this._setError(false);
        this._setLoading(true);
        this._setRequestBody('{ "' + this.name + '": "' + this.$.textInput.value + '" }');
        this.$.ajaxRequest.generateRequest();
      },

      _editValue: function() {
        this._setEditing(true);
        this.$.textInput.value = this.value;
      },

      _saveEdit() {
        this.value = this.$.textInput.value;
        this._finishEdit();
      },

      _cancelEdit: function() {
        this.$.textInput.value = this.value;
        this._finishEdit();
      },

      _finishEdit: function() {
        this._setLoading(false);
        this._setEditing(false);
        this._setError(false);
      },

      _handleResponse: function(e) {
        this._saveEdit();

        if (this.successResponseFunction)
          this.successResponseFunction(e.detail.response);
      },

      _handleErrorResponse: function(e) {
        this._setLoading(false);
        this._setError(true);

        if (this.errorResponseFunction)
          this.errorResponseFunction(e.detail.request.xhr.response, e.detail.request.status);
      },

      _handleKeyDown: function(e) {
        if (this.showButtons)
          return;

        if (e.keyCode === 13) // enter/return key
          this.save();
        else if (e.keyCode === 27) // escape key
          this._cancelEdit();
      },

      _handleBlur: function() {
        if (!this.showButtons)
          this.save();
      },

      _shouldHideButtons: function() {
        return !this.editing || this.loading || !this.showButtons;
      },

      _getInputClasses: function() {
        return this.error ? "error" : "";
      }
      
    });
  </script>
</dom-module>